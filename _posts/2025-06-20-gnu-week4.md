---
layout: post
title: RDS integration and FM Detection
date: 2025-06-20 1:00:00
description: Integrated RDS, and attempt to create a FM radio scanner
tags: gnuradio 
categories: gsoc-updates
featured: false
---

## FM Receiver App â€“ Week 4 Update

This week, I made progress in the following features:

1. Integrating gr-rds rds panel into my frontend application
2. Improve over all GUI and add stylesheets
3. Attempt to Create FM Scanner

---

### RDS Integration & UI Change

Following my last blog, integrating the RDS into my app was a piece of cake. First I moved things around, made some improvement to the UI. The new UI looks like this:
<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/gnu_radio/week4/rds_ui.png" class="img-fluid rounded z-depth-1" %}
    </div>
</div>
Then I used the RDS panel of the [gr-rds](https://github.com/bastibl/gr-rds) OOT module in my application. First i had to import the new flowgraph block ```from flowgraphs.rds_rx import rds_rx``` then instantiate the new FM Receiver `self.rds_fm_receiver = rds_rx()` and save the variable `self.fm_receiver = self.rds_fm_receiver`, finally add the `self.rds_info = self.fm_receiver.rds_panel_0` to the home widget.


### Frequency Scanning 
My initial approach was to scan the spectrum, get the Power Spectral Density to identify candidate stations by their power and verify candidate stations are actually FM station by attempting demodulation and looking for [19kHz pilot tone](https://en.wikipedia.org/wiki/Pilot_signal).

So in attempt to build the scanner, I first started working on the PSD part of the flow graph.

$$
\text{PSD}(f) = 10 \cdot \log_{10} \left( |\text{FFT}(x(t))|^2 \right)
$$

In the flowgraph it looks like this:
<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/gnu_radio/week4/pds_custom_threshold.png" class="img-fluid rounded z-depth-1" %}
    </div>
        <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/gnu_radio/week4/pds_flow.png" class="img-fluid rounded z-depth-1" %}
    </div>
</div>
This is my first attempt with a embedded python block to threshold the values. 

Other Attempts of thresholding are :
<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/gnu_radio/week4/threshold2.png" class="img-fluid rounded z-depth-1" %}
    </div>
        <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/gnu_radio/week4/threshold3.png" class="img-fluid rounded z-depth-1" %}
    </div>
</div>

But later, I noticed that the threshold only works because I'm using the my LNA, when i removed it. No stations were detected regardless of the visible peaks, so I had to implement a relative threshold detector. Luckly the [Peak Detector 2](https://wiki.gnuradio.org/index.php/Peak_Detector2) block in GNU Radio does that, so I converted the vector back to stream to detect the potential active stations.

And finally its time to convert the 1024 fft bins to their coresponding frequencies, for that I used a embedded python block. It computes the frequency location using this equation:

$$
f_i = f_c + \left(i - \frac{N}{2}\right) \cdot \frac{f_s}{N}, \quad \text{for } i = 0, 1, 2, \ldots, N - 1
$$

And sends the output using a pmt message. The flowgraph until now looks like this:
<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/gnu_radio/week4/flowgraph.png" class="img-fluid rounded z-depth-1" %}
    </div>
        <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/gnu_radio/week4/flowgraph2.png" class="img-fluid rounded z-depth-1" %}
    </div>
</div>

#### Problems

I've faced some difficulties implementing the scanner since some of the blocks only deal with streams (Threshold blocks) and others require vectors. It was also hard to visualize, since GNU Radio sinks lack any features to reverse the X-Y axis during plotting or plot frequency bins. But my biggest problem now is how to remove the variations of the detected stations. The threshold values keep deviating and do not stick to a specific value. One approach is to use an averaging function.

The flow graph continuously outputs PMT messages for detected stations. To filter candidates, apply an exponential moving average to nearby frequencies (frequencies in the same proximity), round the result, and use it to verify the presence of a pilot tone.

### What's Next?

For next week, I'm planning to:

- Countiue working on Frequency scanning & Channel Listing: Station Detection and listing
- Advanced/Debug view


**Links**

- [Project Repo](https://github.com/StudHamza/GNU-Radio-FM-App)
- [Weekly Blogs](https://studhamza.github.io/hamza-folio/blog/tag/gnuradio/)
